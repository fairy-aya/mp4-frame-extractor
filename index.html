<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4フレーム抽出ツール</title>
    <style>
        /* CSS Styles remain the same */
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --white: #fff;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2em;
        }

        h2 {
            font-size: 1.5em;
            margin-top: 30px;
        }

        .section {
            background-color: #fdfdfd;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: #f0f6ff;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .upload-area:hover {
            background-color: #e6f0ff;
        }

        .upload-area p {
            margin: 10px 0;
            color: #555;
        }

        .upload-icon {
            font-size: 3em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            text-decoration: none;
            color: var(--white);
        }

        .btn-primary {
            background-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #3a7bc8;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #fileInput {
            display: none;
        }

        #fileList {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        #fileList li {
            background-color: var(--white);
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #fileList .file-name {
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-all;
        }

        #fileList .remove-file {
            color: var(--error-color);
            cursor: pointer;
            font-weight: bold;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .setting-group {
            background-color: var(--white);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .setting-group h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #555;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 8px;
        }

        input[type="number"],
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 1em;
        }

        input[type="number"]:disabled,
        input[type="text"]:disabled {
            background-color: #eee;
        }

        .filename-preview {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid var(--border-color);
        }

        /* Results */
        #resultsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .result-item {
            background-color: var(--white);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .result-item.error {
            border-color: var(--error-color);
        }

        .result-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            background-color: #eee;
        }

        .result-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .result-filename {
            font-weight: bold;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .result-meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .result-error {
            color: var(--error-color);
            font-weight: bold;
        }

        .result-actions {
            margin-top: auto;
        }

        .empty-results {
            text-align: center;
            padding: 30px;
            color: #888;
            grid-column: 1 / -1;
        }

        /* Loading Modal */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background-color: var(--white);
            padding: 30px 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            .grid-container {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.3em;
            }
        }
    </style>
    <!-- FileSaver.js - Add this script for Safari download compatibility -->
    <script>
        (function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("undefined"!=typeof exports)b();else{b(),a.FileSaver={exports:{}}.exports}})(this,function(){"use strict";function b(a,b){return"undefined"==typeof b?b={autoBom:!1}:"object"!=typeof b&&(console.warn("Deprecated: Expected third argument to be a object"),b={autoBom:!b}),b.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function c(a,b,c){var d=new XMLHttpRequest;d.open("GET",a),d.responseType="blob",d.onload=function(){g(d.response,b,c)},d.onerror=function(){console.error("could not download file")},d.send()}function d(a){var b=new XMLHttpRequest;b.open("HEAD",a,!1);try{b.send()}catch(a){}return 200<=b.status&&299>=b.status}function e(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(c){var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}}var f="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,a=f.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),g=f.saveAs||("object"!=typeof window||window!==f?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(b,g,h){var i=f.URL||f.webkitURL,j=document.createElement("a");g=g||b.name||"download",j.download=g,j.rel="noopener","string"==typeof b?(j.href=b,j.origin===location.origin?e(j):d(j.href)?c(b,g,h):e(j,j.target="_blank")):(j.href=i.createObjectURL(b),setTimeout(function(){i.revokeObjectURL(j.href)},4E4),setTimeout(function(){e(j)},0))}:"msSaveOrOpenBlob"in navigator?function(f,g,h){if(g=g||f.name||"download","string"!=typeof f)navigator.msSaveOrOpenBlob(b(f,h),g);else if(d(f))c(f,g,h);else{var i=document.createElement("a");i.href=f,i.target="_blank",setTimeout(function(){e(i)})}}:function(b,d,e,g){if(g=g||open("","_blank"),g&&(g.document.title=g.document.body.innerText="downloading..."),"string"==typeof b)return c(b,d,e);var h="application/octet-stream"===b.type,i=/constructor/i.test(f.HTMLElement)||f.safari,j=/CriOS\/[\d]+/.test(navigator.userAgent);if((j||h&&i||a)&&"undefined"!=typeof FileReader){var k=new FileReader;k.onloadend=function(){var a=k.result;a=j?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"),g?g.location.href=a:location=a,g=null},k.readAsDataURL(b)}else{var l=f.URL||f.webkitURL,m=l.createObjectURL(b);g?g.location=m:location.href=m,g=null,setTimeout(function(){l.revokeObjectURL(m)},4E4)}});f.saveAs=g.saveAs=g,"undefined"!=typeof module&&(module.exports=g)});    </script>
</head>
<body>
    <div class="container">
        <h1><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>MP4フレーム抽出ツール</h1>
        <p style="text-align: center; margin-bottom: 30px; color: #555;">動画ファイルから最終フレームや特定時間のフレームを抽出し、PNG形式で保存できます</p>

        <div class="grid-container">
            <div class="section">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>ファイルアップロード</h2>
                <div id="uploadArea" class="upload-area">
                    <div class="upload-icon">⬆️</div>
                    <p>ここにMP4ファイルをドラッグ＆ドロップ</p>
                    <p>または</p>
                    <button id="selectFilesBtn" class="btn btn-primary">ファイルを選択</button>
                    <input type="file" id="fileInput" multiple accept="video/mp4">
                </div>
                <h3>アップロードファイル一覧</h3>
                <ul id="fileList"></ul>
            </div>

            <div class="section">
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>フレーム抽出設定</h2>
                <div class="settings-grid">
                    <div class="setting-group">
                        <h3>フレーム選択</h3>
                        <label>
                            <input type="radio" name="frameSelection" value="last" checked> 最終フレーム
                        </label>
                        <label>
                            <input type="radio" name="frameSelection" value="specific"> 特定時間のフレーム
                        </label>
                        <input type="number" id="specificTime" min="0" step="0.1" placeholder="秒数を入力 (例: 5.5)" disabled>
                    </div>

                    <div class="setting-group">
                        <h3>リサイズ設定</h3>
                        <label>
                            <input type="checkbox" id="enableResize"> リサイズを有効にする
                        </label>
                        <label for="resizeWidth">幅 (px):</label>
                        <input type="number" id="resizeWidth" min="1" disabled>
                        <label for="resizeHeight">高さ (px):</label>
                        <input type="number" id="resizeHeight" min="1" disabled>
                        <label>
                            <input type="checkbox" id="keepAspectRatio" checked disabled> アスペクト比を維持
                        </label>
                    </div>
                </div>

                <div class="setting-group" style="margin-top: 20px;">
                    <h3>ファイル名設定</h3>
                    <label for="prefix">プレフィックス:</label>
                    <input type="text" id="prefix" value="frame_">
                    <label for="suffix">サフィックス:</label>
                    <input type="text" id="suffix" value="">
                    <label for="startNumber">開始番号:</label>
                    <input type="number" id="startNumber" value="1" min="0">
                    <label for="padding">桁数:</label>
                    <input type="number" id="padding" value="3" min="1">
                    <div class="filename-preview">ファイル名プレビュー: <span id="filenamePreview">frame_001.png</span></div>
                </div>

                <button id="extractBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px; padding: 12px;">フレームを抽出</button>
            </div>
        </div>

        <div id="resultsSection" class="section" style="display: none;">
            <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>抽出結果</h2>
            <button id="downloadAllBtn" class="btn btn-primary" disabled>すべてダウンロード</button>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <div id="loadingModal" class="loading-modal">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loadingMessage">処理中...</p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const uploadArea = document.getElementById("uploadArea");
            const fileInput = document.getElementById("fileInput");
            const selectFilesBtn = document.getElementById("selectFilesBtn");
            const fileList = document.getElementById("fileList");
            const extractBtn = document.getElementById("extractBtn");
            const resultsSection = document.getElementById("resultsSection");
            const resultsContainer = document.getElementById("resultsContainer");
            const downloadAllBtn = document.getElementById("downloadAllBtn");
            const loadingModal = document.getElementById("loadingModal");
            const loadingMessage = document.getElementById("loadingMessage");

            // Settings elements
            const frameSelectionRadios = document.querySelectorAll("input[name=\"frameSelection\"]");
            const specificTimeInput = document.getElementById("specificTime");
            const enableResizeCheckbox = document.getElementById("enableResize");
            const resizeWidthInput = document.getElementById("resizeWidth");
            const resizeHeightInput = document.getElementById("resizeHeight");
            const keepAspectRatioCheckbox = document.getElementById("keepAspectRatio");
            const prefixInput = document.getElementById("prefix");
            const suffixInput = document.getElementById("suffix");
            const startNumberInput = document.getElementById("startNumber");
            const paddingInput = document.getElementById("padding");
            const filenamePreview = document.getElementById("filenamePreview");

            let uploadedFiles = [];
            let extractedFrames = [];

            // File Upload Logic
            selectFilesBtn.addEventListener("click", () => fileInput.click());
            uploadArea.addEventListener("click", (e) => {
                if (e.target === uploadArea || e.target === uploadArea.querySelector(".upload-icon") || e.target.tagName === "P") {
                    fileInput.click();
                }
            });

            ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ["dragenter", "dragover"].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add("highlight"), false);
            });

            ["dragleave", "drop"].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove("highlight"), false);
            });

            uploadArea.addEventListener("drop", handleDrop, false);
            fileInput.addEventListener("change", handleFileSelect, false);

            function handleDrop(e) {
                let dt = e.dataTransfer;
                let files = dt.files;
                handleFiles(files);
            }

            function handleFileSelect(e) {
                handleFiles(e.target.files);
            }

            function handleFiles(files) {
                [...files].forEach(file => {
                    if (file.type === "video/mp4") {
                        if (!uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                            uploadedFiles.push(file);
                        }
                    } else {
                        alert("MP4ファイルのみアップロード可能です: " + file.name);
                    }
                });
                renderFileList();
            }

            function renderFileList() {
                fileList.innerHTML = "";
                uploadedFiles.forEach((file, index) => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span class="file-name">${file.name}</span> <span class="remove-file" data-index="${index}">✖</span>`;
                    fileList.appendChild(li);
                });

                document.querySelectorAll(".remove-file").forEach(button => {
                    button.addEventListener("click", function() {
                        const indexToRemove = parseInt(this.getAttribute("data-index"));
                        uploadedFiles.splice(indexToRemove, 1);
                        renderFileList();
                    });
                });
            }

            // Settings Logic
            frameSelectionRadios.forEach(radio => {
                radio.addEventListener("change", function() {
                    specificTimeInput.disabled = this.value !== "specific";
                });
            });

            enableResizeCheckbox.addEventListener("change", function() {
                const isDisabled = !this.checked;
                resizeWidthInput.disabled = isDisabled;
                resizeHeightInput.disabled = isDisabled;
                keepAspectRatioCheckbox.disabled = isDisabled;
            });

            [prefixInput, suffixInput, startNumberInput, paddingInput].forEach(input => {
                input.addEventListener("input", updateFilenamePreview);
            });

            function updateFilenamePreview() {
                const prefix = prefixInput.value;
                const suffix = suffixInput.value;
                const startNumber = parseInt(startNumberInput.value) || 1;
                const padding = parseInt(paddingInput.value) || 1;
                const numberStr = startNumber.toString().padStart(padding, "0");
                filenamePreview.textContent = `${prefix}${numberStr}${suffix}.png`;
            }
            updateFilenamePreview(); // Initial preview

            // Extraction Logic
            extractBtn.addEventListener("click", function() {
                if (uploadedFiles.length === 0) {
                    alert("MP4ファイルをアップロードしてください");
                    return;
                }
                
                const settings = getExtractionSettings();
                if (settings.frameSelection === "specific" && isNaN(settings.specificTime)) {
                    alert("特定時間を正しく入力してください");
                    return;
                }
                if (settings.enableResize && (isNaN(settings.resizeWidth) || isNaN(settings.resizeHeight))) {
                     if (settings.resizeWidth > 0 || settings.resizeHeight > 0) {
                        // Allow if only one dimension is set and aspect ratio is kept
                        if (!settings.keepAspectRatio || (isNaN(settings.resizeWidth) && isNaN(settings.resizeHeight))) {
                             alert("リサイズ設定の幅と高さを正しく入力してください");
                             return;
                        }
                    } else {
                        alert("リサイズ設定の幅と高さを正しく入力してください");
                        return;
                    }
                }

                showLoading("フレーム抽出中...");
                extractedFrames = [];
                resultsContainer.innerHTML = "";
                downloadAllBtn.disabled = true;
                processFiles(settings);
            });

            function getExtractionSettings() {
                const frameSelection = document.querySelector("input[name=\"frameSelection\"]:checked").value;
                const specificTime = parseFloat(specificTimeInput.value);
                const enableResize = enableResizeCheckbox.checked;
                let resizeWidth = parseInt(resizeWidthInput.value);
                let resizeHeight = parseInt(resizeHeightInput.value);
                const keepAspectRatio = keepAspectRatioCheckbox.checked;
                const prefix = prefixInput.value;
                const suffix = suffixInput.value;
                const startNumber = parseInt(startNumberInput.value);
                const padding = parseInt(paddingInput.value);

                // Handle case where only one dimension is provided for resize with aspect ratio kept
                if (enableResize && keepAspectRatio) {
                    if (!isNaN(resizeWidth) && isNaN(resizeHeight)) {
                        resizeHeight = null; // Indicate height should be calculated
                    } else if (isNaN(resizeWidth) && !isNaN(resizeHeight)) {
                        resizeWidth = null; // Indicate width should be calculated
                    }
                }

                return {
                    frameSelection,
                    specificTime,
                    enableResize,
                    resizeWidth,
                    resizeHeight,
                    keepAspectRatio,
                    naming: {
                        prefix,
                        suffix,
                        start_number: startNumber,
                        padding
                    }
                };
            }

            function processFiles(settings) {
                let processedCount = 0;
                const totalFiles = uploadedFiles.length;

                uploadedFiles.forEach((file, index) => {
                    const fileInfo = { file: file, original_name: file.name };
                    extractFrame(fileInfo, settings, index, totalFiles, (count) => {
                        processedCount = count;
                        if (processedCount === totalFiles) {
                            displayResults();
                            hideLoading();
                            resultsSection.style.display = "block";
                            if (extractedFrames.some(frame => !frame.error)) {
                                downloadAllBtn.disabled = false;
                            }
                        }
                    });
                });
            }

            function extractFrame(fileInfo, settings, index, totalFiles, callback) {
                const video = document.createElement("video");
                video.preload = "metadata";
                let frameExtracted = false;

                video.onloadedmetadata = function() {
                    video.currentTime = (settings.frameSelection === "last") ? video.duration - 0.1 : settings.specificTime;
                };

                video.onseeked = function() {
                    if (frameExtracted) return; // Prevent multiple extractions
                    frameExtracted = true;

                    const canvas = document.createElement("canvas");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // リサイズ処理
                    if (settings.enableResize) {
                        let originalWidth = canvas.width;
                        let originalHeight = canvas.height;
                        let newWidth = settings.resizeWidth;
                        let newHeight = settings.resizeHeight;

                        if (settings.keepAspectRatio) {
                            const aspectRatio = originalWidth / originalHeight;
                            if (newWidth !== null && newHeight === null) {
                                newHeight = Math.round(newWidth / aspectRatio);
                            } else if (newWidth === null && newHeight !== null) {
                                newWidth = Math.round(newHeight * aspectRatio);
                            } else if (newWidth !== null && newHeight !== null) {
                                // If both are set, prioritize width and adjust height
                                newHeight = Math.round(newWidth / aspectRatio);
                            }
                        }
                        
                        // Ensure valid dimensions
                        newWidth = newWidth > 0 ? newWidth : originalWidth;
                        newHeight = newHeight > 0 ? newHeight : originalHeight;

                        if (newWidth !== originalWidth || newHeight !== originalHeight) {
                            const resizedCanvas = document.createElement("canvas");
                            resizedCanvas.width = newWidth;
                            resizedCanvas.height = newHeight;
                            const resizedCtx = resizedCanvas.getContext("2d");
                            resizedCtx.drawImage(canvas, 0, 0, originalWidth, originalHeight, 0, 0, newWidth, newHeight);
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            ctx.drawImage(resizedCanvas, 0, 0);
                        }
                    }

                    // ファイル名の生成
                    const namingSettings = settings.naming;
                    const prefix = namingSettings.prefix;
                    const suffix = namingSettings.suffix;
                    const startNumber = namingSettings.start_number;
                    const padding = namingSettings.padding;
                    const number = startNumber + index;
                    const numberStr = number.toString().padStart(padding, "0");
                    const filename = `${prefix}${numberStr}${suffix}.png`;

                    // PNGデータを取得
                    const dataURL = canvas.toDataURL("image/png");

                    // 結果を保存
                    extractedFrames.push({
                        original_name: fileInfo.original_name,
                        frame_filename: filename,
                        width: canvas.width,
                        height: canvas.height,
                        dataURL: dataURL
                    });

                    URL.revokeObjectURL(video.src); // Clean up blob URL
                    callback(index + 1);
                };

                video.onerror = function() {
                    console.error("Error processing video:", fileInfo.original_name);
                    extractedFrames.push({
                        original_name: fileInfo.original_name,
                        error: "ビデオの処理中にエラーが発生しました"
                    });
                    URL.revokeObjectURL(video.src); // Clean up blob URL
                    callback(index + 1);
                };

                video.src = URL.createObjectURL(fileInfo.file);
            }

            // 結果の表示
            function displayResults() {
                resultsContainer.innerHTML = "";
                if (extractedFrames.length === 0) {
                    resultsContainer.innerHTML = 
                    return;
                }

                extractedFrames.forEach((frame, index) => {
                    if (frame.error) {
                        const errorItem = document.createElement("div");
                        errorItem.className = "result-item error";
                        errorItem.innerHTML = `
                            <div class="result-info">
                                <div class="result-filename">${frame.original_name}</div>
                                <div class="result-error">${frame.error}</div>
                            </div>
                        `;
                        resultsContainer.appendChild(errorItem);
                        return;
                    }

                    const resultItem = document.createElement("div");
                    resultItem.className = "result-item";
                    resultItem.innerHTML = `
                        <img src="${frame.dataURL}" alt="${frame.original_name}" class="result-image">
                        <div class="result-info">
                            <div class="result-filename">${frame.frame_filename}</div>
                            <div class="result-meta">
                                元ファイル: ${frame.original_name}<br>
                                解像度: ${frame.width}x${frame.height}
                            </div>
                            <div class="result-actions">
                                <button class="btn btn-primary download-frame" data-index="${index}">ダウンロード</button>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(resultItem);
                });

                document.querySelectorAll(".download-frame").forEach(button => {
                    button.addEventListener("click", function() {
                        const index = parseInt(this.getAttribute("data-index"));
                        downloadFrame(extractedFrames[index]);
                    });
                });
            }

            // --- Safari Fix Start ---
            // Safariを検出する関数
            function isSafari() {
                return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            }

            // フレームのダウンロード (Safari対応版)
            function downloadFrame(frame) {
                if (!frame || !frame.dataURL || !frame.frame_filename) {
                    console.error("Invalid frame data for download:", frame);
                    alert("ダウンロードデータが無効です。");
                    return;
                }
                
                const filename = frame.frame_filename;
                const dataURL = frame.dataURL;

                // Safariの場合はFileSaver.jsを使用
                if (isSafari()) {
                    // Data URLからBlobを作成
                    fetch(dataURL)
                        .then(res => res.blob())
                        .then(blob => {
                            // FileSaver.jsを使用してダウンロード
                            saveAs(blob, filename); // saveAs is defined by FileSaver.js
                        })
                        .catch(err => {
                            console.error("Safari download error using FileSaver:", err);
                            // フォールバック: 新しいウィンドウで開く (ダウンロードされない可能性あり)
                            try {
                                const newWindow = window.open(dataURL, "_blank");
                                if (!newWindow) {
                                    alert("ポップアップがブロックされたため、ダウンロードを開始できませんでした。ポップアップを許可して再試行してください。");
                                }
                            } catch (openErr) {
                                console.error("Error opening fallback window:", openErr);
                                alert("ダウンロード中にエラーが発生しました。ブラウザの設定を確認してください。");
                            }
                        });
                } else {
                    // Chrome等他のブラウザでは従来の方法
                    try {
                        const link = document.createElement("a");
                        link.href = dataURL;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    } catch (err) {
                        console.error("Standard download error:", err);
                        alert("ダウンロード中にエラーが発生しました。");
                    }
                }
            }
            // --- Safari Fix End ---

            // すべてダウンロードボタン
            downloadAllBtn.addEventListener("click", function() {
                if (extractedFrames.length === 0) return;
                
                let downloadableFrames = extractedFrames.filter(frame => !frame.error);
                if (downloadableFrames.length === 0) {
                    alert("ダウンロード可能なフレームがありません。");
                    return;
                }

                showLoading(`ダウンロード準備中... (${downloadableFrames.length}件)`);

                // 各フレームを順番にダウンロード (Safari対応)
                downloadableFrames.forEach((frame, index) => {
                    // 少し遅延させて連続ダウンロードを試みる (ブラウザによっては制限あり)
                    setTimeout(() => {
                        console.log(`Downloading frame ${index + 1}: ${frame.frame_filename}`);
                        downloadFrame(frame);
                        if (index === downloadableFrames.length - 1) {
                            hideLoading();
                        }
                    }, index * 800); // Delay increased slightly
                });
            });

            // ローディング表示
            function showLoading(message) {
                loadingMessage.textContent = message || "処理中...";
                loadingModal.classList.add("show");
            }

            function hideLoading() {
                loadingModal.classList.remove("show");
            }
        });
    </script>
</body>
</html>
